# 聊天室数据管理系统说明

## 概述

本系统实现了完整的数据管理功能，包括用户数据管理和配置文件管理。

## 用户数据管理

### 数据库位置
- **路径**: `backend/db/users.db`
- **类型**: SQLite数据库

### 用户表结构
```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,  -- 用户ID（自增）
    username TEXT UNIQUE NOT NULL,          -- 用户名（唯一）
    password_hash TEXT NOT NULL,            -- 密码哈希（bcrypt加密）
    nickname TEXT NOT NULL,                 -- 昵称
    created_at TEXT DEFAULT CURRENT_TIMESTAMP, -- 注册时间
    last_login TEXT,                        -- 最后登录时间
    status TEXT DEFAULT 'offline'           -- 在线状态（online/offline）
);
```

### 密码加密
- 使用 **bcrypt** 算法进行密码加密
- 密码存储为不可逆的哈希值
- 登录时通过bcrypt验证密码

### 用户模型API
位置：`backend/models/user.py`

主要方法：
- `register(username, password, nickname)` - 注册新用户
- `login(username, password)` - 用户登录验证
- `update_status(username, status)` - 更新用户在线状态
- `get_user(username)` - 获取用户信息

## 配置文件管理

### 配置文件位置
- **路径**: `backend/config/config.json`
- **首次运行**: 自动创建默认配置文件

### 配置文件结构

```json
{
    "app": {
        "secret_key": "your-secret-key-here-change-it"  // Flask密钥
    },
    "servers": [  // 服务器列表（多服务器支持）
        {
            "name": "本地服务器",
            "url": "http://localhost:5000"
        },
        {
            "name": "局域网服务器",
            "url": "http://192.168.1.100:5000"
        }
    ],
    "apis": {
        "weather": {  // 天气API配置
            "provider": "wttr.in",
            "wttr_url": "https://wttr.in",
            "qweather_key": "",  // 和风天气API密钥（可选）
            "qweather_url": "https://devapi.qweather.com/v7"
        },
        "news": {  // 新闻API配置
            "provider": "alapi",
            "alapi_token": "你的ALAPI令牌",
            "alapi_url": "https://v2.alapi.cn/api"
        },
        "music": {  // 音乐API配置
            "provider": "alapi",
            "alapi_token": "你的ALAPI令牌",
            "alapi_search_url": "https://v2.alapi.cn/api/music/search",
            "alapi_url_api": "https://v2.alapi.cn/api/music/url",
            "player_url": "https://v3.alapi.cn/api/music/url"
        },
        "ai": {  // AI对话API配置
            "provider": "siliconflow",
            "api_key": "你的API密钥",
            "base_url": "https://api.siliconflow.cn/v1/",
            "model": "Qwen/Qwen2.5-7B-Instruct"
        }
    },
    "themes": {  // 天气主题映射
        "weather_backgrounds": {
            "sunny": "weather-sunny",
            "cloudy": "weather-cloudy",
            "rainy": "weather-rainy",
            "snowy": "weather-snowy"
        }
    },
    "features": {  // 功能开关
        "enable_music": true,
        "enable_weather": true,
        "enable_news": true,
        "enable_ai": true,
        "enable_movie": true
    }
}
```

### 配置管理器API
位置：`backend/models/config.py`

主要方法：
- `get(key, default)` - 获取配置项（支持点号路径，如 'apis.weather.provider'）
- `set(key, value)` - 设置配置项
- `get_servers()` - 获取服务器列表
- `add_server(name, url)` - 添加服务器
- `get_api_config(api_name)` - 获取API配置
- `update_api_config(api_name, config)` - 更新API配置
- `is_feature_enabled(feature)` - 检查功能是否启用
- `get_weather_theme(weather)` - 获取天气主题

## 手动编辑配置

### 修改API密钥
1. 打开 `backend/config/config.json`
2. 找到对应的API配置部分
3. 修改 `api_key` 或 `alapi_token` 字段
4. 保存文件并重启服务器

示例 - 修改和风天气API密钥：
```json
"weather": {
    "provider": "wttr.in",
    "wttr_url": "https://wttr.in",
    "qweather_key": "你的和风天气密钥",  // 在这里修改
    "qweather_url": "https://devapi.qweather.com/v7"
}
```

### 添加服务器地址
1. 打开 `backend/config/config.json`
2. 在 `servers` 数组中添加新服务器
3. 保存文件

示例：
```json
"servers": [
    {
        "name": "本地服务器",
        "url": "http://localhost:5000"
    },
    {
        "name": "新服务器",  // 新增
        "url": "http://192.168.1.200:5000"
    }
]
```

### 修改天气背景映射
1. 打开 `backend/config/config.json`
2. 修改 `themes.weather_backgrounds` 部分
3. 键名为天气类型，值为CSS类名

示例：
```json
"weather_backgrounds": {
    "sunny": "weather-sunny",
    "cloudy": "weather-cloudy",
    "rainy": "weather-rainy",
    "snowy": "weather-snowy"
}
```

## 数据初始化

### 首次运行
1. 启动服务器：`python app.py`
2. 系统自动检查：
   - 如果 `config.json` 不存在 → 创建默认配置
   - 如果 `users.db` 不存在 → 创建用户数据库

### 重置配置
1. 停止服务器
2. 删除 `backend/config/config.json`
3. 重启服务器 → 自动创建默认配置

### 重置用户数据
1. 停止服务器
2. 删除 `backend/db/users.db`
3. 重启服务器 → 自动创建空数据库

## 管理接口（仅管理员）

### 获取配置
```http
GET /api/config
```

返回完整配置JSON

### 更新配置
```http
POST /api/config
Content-Type: application/json

{
    "key": "apis.weather.qweather_key",
    "value": "新的API密钥"
}
```

**注意**: 当前未实现管理员验证，后续需要添加权限控制

## 安全建议

1. **密钥保护**：不要将config.json提交到公开仓库
2. **修改默认密钥**：首次部署时修改 `app.secret_key`
3. **添加管理员验证**：在管理接口中添加身份验证
4. **定期备份**：定期备份 `users.db` 数据库
5. **HTTPS部署**：生产环境使用HTTPS传输

## 维护建议

### 查看用户列表
```bash
sqlite3 backend/db/users.db "SELECT username, nickname, created_at, last_login, status FROM users;"
```

### 查看在线用户
```bash
sqlite3 backend/db/users.db "SELECT username, nickname FROM users WHERE status='online';"
```

### 备份数据库
```bash
cp backend/db/users.db backend/db/users_backup_$(date +%Y%m%d).db
```

### 检查配置文件
```bash
cat backend/config/config.json | python -m json.tool
```

## 开发顺序建议

按照功能指令1的建议顺序：
1. ✅ 用户系统（已完成）
2. ⏳ @功能开发（天气、音乐、新闻等，已集成配置管理）
3. ⏳ 数据管理与沉浸式优化

## 常见问题

### Q: 如何修改API密钥？
A: 编辑 `backend/config/config.json`，修改对应的 `api_key` 或 `token` 字段，保存后重启服务器。

### Q: 如何添加新功能？
A: 
1. 在 `config.json` 的 `features` 中添加开关
2. 使用 `config_manager.is_feature_enabled('功能名')` 检查
3. 在 `apis` 中添加对应API配置

### Q: 数据库文件在哪里？
A: `backend/db/users.db`

### Q: 如何重置所有数据？
A: 删除 `backend/db/users.db` 和 `backend/config/config.json`，重启服务器自动重建。
